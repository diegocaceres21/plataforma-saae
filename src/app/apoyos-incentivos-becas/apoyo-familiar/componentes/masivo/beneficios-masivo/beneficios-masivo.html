<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100 p-6">
  <!-- Header Section -->
  <div class="max-w-7xl mx-auto mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-slate-900 mb-2">Registro Masivo de Beneficios</h1>
        <p class="text-slate-600">Procesa múltiples beneficios individuales desde un archivo Excel</p>
      </div>
      
      <button
        routerLink="/menu"
        class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white rounded-lg transition-colors duration-200 shadow-sm">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Volver al Menú
      </button>
    </div>
  </div>

  <div class="max-w-7xl mx-auto space-y-6">
    
    <!-- Step 1: Download Template -->
    @if (currentStep === 1) {
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 font-bold text-lg">
              1
            </div>
          </div>
          
          <div class="ml-4 flex-1">
            <h2 class="text-xl font-semibold text-slate-900 mb-2">Descarga la Plantilla Excel</h2>
            <p class="text-slate-600 mb-4">
              Descarga la plantilla con la estructura requerida para registrar beneficios individuales
            </p>
            
            <button
              (click)="descargarPlantilla()"
              class="inline-flex items-center px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Descargar Plantilla
            </button>
            
            <button
              (click)="currentStep = 2"
              class="ml-3 inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
              Continuar
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Step 2: Upload File -->
    @if (currentStep === 2) {
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 font-bold text-lg">
              2
            </div>
          </div>
          
          <div class="ml-4 flex-1">
            <h2 class="text-xl font-semibold text-slate-900 mb-2">Sube el Archivo Excel</h2>
            <p class="text-slate-600 mb-4">
              Sube el archivo Excel completado con los beneficios de los estudiantes
            </p>
            
            <div
              (click)="fileInput.click()"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              [class.border-blue-500]="isDragging"
              [class.bg-blue-50]="isDragging"
              class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-slate-50 transition-all duration-200">
              
              @if (!selectedFile) {
                <svg class="w-16 h-16 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-lg font-medium text-slate-700 mb-2">
                  {{ isDragging ? '¡Suelta el archivo aquí!' : 'Arrastra el archivo aquí o haz clic para seleccionar' }}
                </p>
                <p class="text-sm text-slate-500">Archivos Excel (.xlsx, .xls)</p>
              } @else {
                <svg class="w-16 h-16 mx-auto text-emerald-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-lg font-medium text-slate-700 mb-2">{{ selectedFile.name }}</p>
                <p class="text-sm text-slate-500">{{ (selectedFile.size / 1024).toFixed(2) }} KB</p>
              }
              
              <input
                #fileInput
                type="file"
                accept=".xlsx,.xls"
                (change)="onFileSelected($event)"
                class="hidden" />
            </div>
            
            @if (selectedFile) {
              <div class="mt-4 flex gap-3">
                <button
                  (click)="procesarArchivo()"
                  [disabled]="isProcessing"
                  class="flex-1 inline-flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                  {{ isProcessing ? 'Procesando...' : 'Procesar Archivo' }}
                </button>
                
                <button
                  (click)="selectedFile = null"
                  [disabled]="isProcessing"
                  class="px-6 py-3 bg-slate-200 hover:bg-slate-300 disabled:bg-slate-100 text-slate-700 font-semibold rounded-lg transition-colors duration-200">
                  Cancelar
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    }

    <!-- Step 3: Preview and Calculate -->
    @if (currentStep === 3 && uploadedEstudiantes.length > 0 && processedEstudiantes.length === 0) {
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-start mb-6">
          <div class="flex-shrink-0">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 font-bold text-lg">
              3
            </div>
          </div>
          
          <div class="ml-4 flex-1">
            <h2 class="text-xl font-semibold text-slate-900 mb-2">Vista Previa y Validación</h2>
            <p class="text-slate-600">
              Revisa los datos cargados antes de procesar. Total de estudiantes: <span class="font-semibold">{{ uploadedEstudiantes.length }}</span>
            </p>
          </div>
        </div>

        <!-- Preview Table -->
        <div class="overflow-x-auto rounded-lg border border-slate-200">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Fila</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Nombre</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Carnet</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Beneficio</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Porcentaje</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Estado</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
              @for (estudiante of uploadedEstudiantes; track estudiante.rowNumber) {
                <tr [class.bg-red-50]="estudiante.hasErrors">
                  <td class="px-4 py-3 text-sm text-slate-900">{{ estudiante.rowNumber }}</td>
                  <td class="px-4 py-3 text-sm text-slate-900">{{ estudiante.nombre }}</td>
                  <td class="px-4 py-3 text-sm font-mono text-slate-900">{{ estudiante.carnet }}</td>
                  <td class="px-4 py-3 text-sm text-slate-900">{{ estudiante.beneficio }}</td>
                  <td class="px-4 py-3 text-sm text-slate-900">{{ ((estudiante.porcentaje || 0) * 100).toFixed(0) }}%</td>
                  <td class="px-4 py-3">
                    @if (estudiante.hasErrors) {
                      <div class="flex items-center text-red-600">
                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs">{{ estudiante.errorMessage }}</span>
                      </div>
                    } @else {
                      <div class="flex items-center text-emerald-600">
                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs">OK</span>
                      </div>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex gap-3">
          <button
            (click)="calcularDescuentos()"
            [disabled]="isCalculating || hasAllErrors()"
            class="flex-1 inline-flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ isCalculating ? 'Calculando...' : 'Calcular Descuentos' }}
          </button>
          
          <button
            (click)="currentStep = 2; uploadedEstudiantes = []; selectedFile = null"
            [disabled]="isCalculating"
            class="px-6 py-3 bg-slate-200 hover:bg-slate-300 disabled:bg-slate-100 text-slate-700 font-semibold rounded-lg transition-colors duration-200">
            Volver
          </button>
        </div>
      </div>
    }

    <!-- Step 4: Results -->
    @if (processedEstudiantes.length > 0) {
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-start mb-6">
          <div class="flex-shrink-0">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 font-bold text-lg">
              4
            </div>
          </div>
          
          <div class="ml-4 flex-1">
            <h2 class="text-xl font-semibold text-slate-900 mb-2">Resultados del Procesamiento</h2>
            <p class="text-slate-600">
              Validación completada. Revisa los resultados y guarda los registros válidos.
            </p>
          </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="w-8 h-8 text-emerald-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <p class="text-sm text-emerald-700 font-medium">Exitosos</p>
                <p class="text-2xl font-bold text-emerald-900">{{ validEstudiantesCount }}</p>
              </div>
            </div>
          </div>

          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="w-8 h-8 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <p class="text-sm text-red-700 font-medium">Con Errores</p>
                <p class="text-2xl font-bold text-red-900">{{ errorEstudiantesCount }}</p>
              </div>
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="w-8 h-8 text-blue-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <p class="text-sm text-blue-700 font-medium">Total</p>
                <p class="text-2xl font-bold text-blue-900">{{ processedEstudiantes.length }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Table -->
        <div class="overflow-x-auto rounded-lg border border-slate-200">
          <table class="w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Fila</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Estudiante</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Carnet</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Carrera</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Beneficio</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Descuento</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Estado</th>

                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Total UVE</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Plan</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Pagos Realizados</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Saldo Semestre</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
              @for (estudiante of processedEstudiantes; track estudiante.rowNumber) {
                <tr 
                  [class.bg-red-50]="estudiante.hasErrors" 
                  [class.bg-blue-50]="esReemplazo(estudiante) && !estudiante.hasErrors"
                  [class.bg-orange-50]="esInactivo(estudiante) && !estudiante.hasErrors"
                  [class.bg-amber-50]="esPorcentajeDiferente(estudiante) && !estudiante.hasErrors">
                  <td class="px-4 py-3 text-sm text-slate-900">{{ estudiante.rowNumber }}</td>
                  <td class="px-4 py-3 text-sm text-slate-900">{{ estudiante.nombre }}</td>
                  <td class="px-4 py-3 text-sm font-mono text-slate-900">{{ estudiante.carnet }}</td>
                  <td class="px-4 py-3 text-sm text-slate-900">
                    @if (!estudiante.hasErrors && estudiante.registro) {
                      {{ estudiante.registro.carrera }}
                    } @else {
                      -
                    }
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-900">{{ estudiante.beneficio }}</td>
                  <td class="px-4 py-3 text-sm">
                    @if (!estudiante.hasErrors && estudiante.registro) {
                      <div class="flex items-center gap-2">
                        <input
                          type="number"
                          [ngModel]="getPorcentajeDisplay(estudiante)"
                          (ngModelChange)="actualizarPorcentaje(estudiante, $event)"
                          min="0"
                          max="100"
                          step="0.01"
                          class="w-20 px-2 py-1 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <span class="text-slate-600">%</span>
                        @if (estudiante.hasWarning && estudiante.porcentajeSugerido) {
                          <button
                            (click)="aplicarPorcentajeSugerido(estudiante)"
                            class="text-xs text-amber-600 hover:text-amber-700 underline whitespace-nowrap"
                            title="Aplicar porcentaje sugerido del beneficio">
                            (Sug: {{ (estudiante.porcentajeSugerido * 100).toFixed(2) }}%)
                          </button>
                        }
                      </div>
                    } @else {
                      -
                    }
                  </td>
                  <td class="px-4 py-3">
                    @if (estudiante.hasErrors) {
                      <!-- ERROR: Mismo beneficio o error de validación -->
                      <div class="flex items-start text-red-600">
                        <svg class="w-5 h-5 mr-1 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs">{{ estudiante.errorMessage }}</span>
                      </div>
                    } @else if (esReemplazo(estudiante)) {
                      <!-- REEMPLAZO: Nuevo porcentaje mayor - Reemplazará el anterior -->
                      <div class="flex items-start text-blue-600">
                        <svg class="w-5 h-5 mr-1 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <div class="space-y-0">
                          <p class="text-xs font-semibold leading-none mb-0.5">Reemplazará</p>
                          <span class="text-xs break-words leading-3.5 block" [title]="estudiante.warningMessage">{{ estudiante.warningMessage }}</span>
                        </div>
                      </div>
                    } @else if (esInactivo(estudiante)) {
                      <!-- INACTIVO: Nuevo porcentaje menor/igual - Se guarda inactivo -->
                      <div class="flex items-start text-orange-600">
                        <svg class="w-5 h-5 mr-1 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                        </svg>
                        <div class="space-y-0">
                          <p class="text-xs font-semibold leading-none mb-0.5">Menor descuento</p>
                          <span class="text-xs break-words leading-3.5 block" [title]="estudiante.warningMessage">{{ estudiante.warningMessage }}</span>
                        </div>
                      </div>
                    } @else if (esPorcentajeDiferente(estudiante)) {
                      <!-- ADVERTENCIA: Porcentaje diferente al sugerido -->
                      <div class="flex items-start text-amber-600">
                        <svg class="w-5 h-5 mr-1 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs break-words" [title]="estudiante.warningMessage">{{ estudiante.warningMessage }}</span>
                      </div>
                    } @else {
                      <!-- SIN CONFLICTOS -->
                      <div class="flex items-center text-emerald-600">
                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs">Validado</span>
                      </div>
                    }
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-900">
                    @if (!estudiante.hasErrors && estudiante.registro) {
                      {{ estudiante.registro.total_creditos }}
                    } @else {
                      -
                    }
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-900">
                    @if (!estudiante.hasErrors && estudiante.registro) {
                      {{ estudiante.registro.plan_primer_pago }}
                    } @else {
                      -
                    }
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-900">
                    @if (!estudiante.hasErrors && estudiante.registro) {
                      {{ (estudiante.registro.monto_primer_pago || 0) +  ((estudiante.registro.pagos_realizados || 0) + (estudiante.registro.pago_credito_tecnologico? estudiante.registro.credito_tecnologico! : 0))  | currency:'Bs. ':'symbol':'1.2-2' }}
                    } @else {
                      -
                    }
                  </td>
                  <!--
                  
                  -->
                  <td class="px-4 py-3 text-sm text-slate-900">
                    @if (!estudiante.hasErrors && estudiante.registro) {
                      {{ obtenerSaldoConDescuento(estudiante.registro) | currency:'Bs. ':'symbol':'1.2-2' }}
                    } @else {
                      -
                    }
                  </td>


                  <td class="px-4 py-3 text-center">
                    <button
                      (click)="confirmarEliminarEstudiante(estudiante)"
                      class="inline-flex items-center justify-center p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors duration-200"
                      title="Eliminar estudiante">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex gap-3">
          <button
            (click)="iniciarAgregarEstudiante()"
            class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
            </svg>
            Agregar Estudiante
          </button>

          <button
            (click)="guardarRegistros()"
            [disabled]="validEstudiantesCount === 0"
            class="flex-1 inline-flex items-center justify-center px-6 py-3 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-300 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
            </svg>
            Guardar Registros Válidos ({{ validEstudiantesCount }})
          </button>
          
          <button
            (click)="currentStep = 2; uploadedEstudiantes = []; processedEstudiantes = []; selectedFile = null"
            class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg transition-colors duration-200">
            Nuevo Proceso
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Results Modal -->
  @if (showResumenModal) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
          <h3 class="text-xl font-bold text-white">Resumen de Guardado</h3>
        </div>

        <div class="p-6 overflow-y-auto max-h-[calc(80vh-140px)]">
          <!-- Summary -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
              <p class="text-sm text-emerald-700 font-medium mb-1">Guardados Exitosamente</p>
              <p class="text-3xl font-bold text-emerald-900">{{ estudiantesExitosos.length }}</p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <p class="text-sm text-red-700 font-medium mb-1">Errores al Guardar</p>
              <p class="text-3xl font-bold text-red-900">{{ estudiantesFallidos.length }}</p>
            </div>
          </div>

          <!-- Results List -->
          <div class="space-y-3">
            @for (resultado of resultadosGuardado; track $index) {
              <div [class]="resultado.exito ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200'" 
                   class="border rounded-lg p-4">
                <div class="flex items-start">
                  @if (resultado.exito) {
                    <svg class="w-6 h-6 text-emerald-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                  } @else {
                    <svg class="w-6 h-6 text-red-600 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                  }
                  <div class="flex-1">
                    <p [class]="resultado.exito ? 'text-emerald-900' : 'text-red-900'" class="font-medium">
                      {{ resultado.estudiante.nombre }}
                    </p>
                    @if (resultado.exito) {
                      <p class="text-sm text-emerald-700 mt-1">
                        Solicitud guardada exitosamente (ID: {{ resultado.id_solicitud }})
                      </p>
                    } @else {
                      <p class="text-sm text-red-700 mt-1">{{ resultado.error }}</p>
                      @if (resultado.detalles) {
                        <p class="text-xs text-red-600 mt-1">{{ resultado.detalles }}</p>
                      }
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3">
          <button
            (click)="showResumenModal = false; currentStep = 2; uploadedEstudiantes = []; processedEstudiantes = []; selectedFile = null"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Delete Student Confirmation Modal -->
  @if (showDeleteStudentModal && estudianteToDelete) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
        
        <!-- Modal Header -->
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-slate-900">Confirmar Eliminación</h3>
            <p class="text-sm text-slate-600 mt-1">Esta acción no se puede deshacer</p>
          </div>
        </div>
        
        <!-- Modal Body -->
        <div class="mb-6">
          <p class="text-slate-700 mb-3">
            ¿Estás seguro de que deseas eliminar a <strong>{{ estudianteToDelete.nombre }}</strong> de la lista?
          </p>
          
          <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
            <div class="flex items-center gap-3 mb-2">
              <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
              </svg>
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-900">{{ estudianteToDelete.nombre }}</p>
                <p class="text-xs text-slate-500">Carnet: {{ estudianteToDelete.carnet }} • Beneficio: {{ estudianteToDelete.beneficio }}</p>
              </div>
            </div>
            @if (estudianteToDelete.registro) {
              <div class="flex items-center justify-between text-xs text-slate-600 mt-2 pt-2 border-t border-slate-200">
                <span>{{ estudianteToDelete.registro.total_creditos }} UVE</span>
                <span>{{ (estudianteToDelete.registro.porcentaje_descuento * 100).toFixed(0) }}% descuento</span>
                <span>{{ estudianteToDelete.registro.plan_primer_pago }}</span>
              </div>
            }
          </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="flex gap-3">
          <button
            type="button"
            (click)="cancelarEliminarEstudiante()"
            class="flex-1 px-4 py-2.5 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-colors duration-200">
            Cancelar
          </button>
          <button
            type="button"
            (click)="ejecutarEliminarEstudiante()"
            class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
            Eliminar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Add Student Modal -->
  @if (showAgregarEstudianteModal) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="bg-emerald-50 border-b border-emerald-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-slate-900">Agregar Estudiante</h3>
                <p class="text-sm text-slate-600">Busca y selecciona un estudiante para agregar a la lista</p>
              </div>
            </div>
            <button
              type="button"
              (click)="cerrarModalAgregarEstudiante()"
              [disabled]="isAddingStudent"
              class="text-slate-400 hover:text-slate-600 transition-colors disabled:opacity-50">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
          <div class="mb-6">
            <p class="text-sm text-slate-600 mb-4">
              Completa los siguientes campos para agregar un estudiante a la lista de beneficios.
            </p>
          </div>
          
          <!-- Student Autocomplete -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              1. Buscar Estudiante
            </label>
            <app-student-autocomplete
              [excludedCIs]="excludedCIsForAgregar"
              (studentSelected)="onStudentSelected($event)"
              [disabled]="isAddingStudent">
            </app-student-autocomplete>
            @if (selectedStudent) {
              <div class="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                <div class="flex items-center gap-2">
                  <svg class="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <div>
                    <p class="text-sm font-medium text-emerald-900">{{ selectedStudent.nombre }}</p>
                    <p class="text-xs text-emerald-700">Carnet: {{ selectedStudent.carnet }}</p>
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Beneficio Selection -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              2. Seleccionar Beneficio *
            </label>
            <select
              [(ngModel)]="selectedBeneficioId"
              (ngModelChange)="onBeneficioChange()"
              [disabled]="!selectedStudent || isAddingStudent"
              class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-slate-100 disabled:cursor-not-allowed">
              <option value="">-- Seleccione un beneficio --</option>
              @for (beneficio of beneficiosDisponibles; track beneficio.id) {
                <option [value]="beneficio.id">{{ beneficio.nombre }}@if (beneficio.porcentaje && beneficio.porcentaje > 0) { ({{ (beneficio.porcentaje * 100).toFixed(0) }}%)}</option>
              }
            </select>
          </div>

          <!-- Porcentaje Input -->
          <div class="mb-6">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              3. Porcentaje de Descuento * (0-100)
            </label>
            <div class="relative">
              <input
                type="number"
                [(ngModel)]="selectedPorcentaje"
                [disabled]="!selectedStudent || isAddingStudent"
                min="0"
                max="100"
                step="1"
                placeholder="Ej: 50"
                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-slate-100 disabled:cursor-not-allowed">
              <span class="absolute right-3 top-2 text-slate-500">%</span>
            </div>
            @if (selectedPorcentaje > 0 && selectedPorcentaje <= 100) {
              <p class="text-xs text-emerald-600 mt-1">✓ Porcentaje válido</p>
            } @else if (selectedPorcentaje > 100) {
              <p class="text-xs text-red-600 mt-1">⚠ El porcentaje no puede ser mayor a 100%</p>
            }
          </div>

          <!-- Summary -->
          @if (puedeAgregarEstudiante) {
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="text-sm font-semibold text-blue-900 mb-2">Resumen</h4>
              <div class="space-y-1 text-sm text-blue-800">
                <p><span class="font-medium">Estudiante:</span> {{ selectedStudent?.nombre }}</p>
                <p><span class="font-medium">Carnet:</span> {{ selectedStudent?.carnet }}</p>
                <p><span class="font-medium">Beneficio:</span> {{ selectedBeneficioNombre }}</p>
                <p><span class="font-medium">Descuento:</span> {{ selectedPorcentaje }}%</p>
              </div>
            </div>
          }
          
          <!-- Current Students Count -->
          @if (processedEstudiantes.length > 0) {
            <div class="mt-6">
              <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-slate-600" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    <p class="text-sm font-medium text-slate-700">Estudiantes en la lista:</p>
                  </div>
                  <p class="text-lg font-bold text-slate-900">{{ processedEstudiantes.length }}</p>
                </div>
              </div>
            </div>
          }
        </div>
        
        <!-- Modal Footer -->
        <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3">
          <button
            type="button"
            (click)="cerrarModalAgregarEstudiante()"
            [disabled]="isAddingStudent"
            class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-colors disabled:opacity-50">
            Cancelar
          </button>
          <button
            type="button"
            (click)="agregarNuevoEstudiante()"
            [disabled]="!puedeAgregarEstudiante || isAddingStudent"
            class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
            <span class="flex items-center gap-2">
              @if (isAddingStudent) {
                <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Agregando...
              } @else {
                Agregar Estudiante
              }
            </span>
          </button>
        </div>
      </div>
    </div>
  }
  
  <!-- Toast Container -->
  <app-toast-container></app-toast-container>
</div>
